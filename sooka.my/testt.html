<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Penstriman Video</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.6/shaka-player.compiled.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-color: #000;
            color: #fff;
            font-family: Arial, sans-serif;
        }
        video {
            width: 100%;
            max-width: 800px;
            height: auto;
        }
        .controls {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
        select {
            padding: 5px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <video id="video" controls autoplay></video>
    
    <div class="controls">
        <label for="resolution">Resolusi:</label>
        <select id="resolution">
            <option value="auto">Auto</option>
        </select>

        <label for="audio">Audio:</label>
        <select id="audio"></select>
    </div>

    <script>
        async function initPlayer() {
            // URL Manifest (Obfuscated)
            const encodedManifest = [
                "\x68\x74\x74\x70\x73", "\x3a\x2f\x2f\x6c\x69\x6e\x65\x61\x72\x6a\x69\x74\x70\x2d\x70\x6c\x61\x79\x62\x61\x63\x6b",
                "\x2e\x61\x73\x74\x72\x6f\x2e\x63\x6f\x6d\x2e\x6d\x79\x2f\x64\x61\x73\x68\x2d\x77\x76\x2f\x6c\x69\x6e\x65\x61\x72",
                "\x2f\x35\x31\x30\x38\x2f\x64\x65\x66\x61\x75\x6c\x74\x5f\x70\x72\x69\x6d\x61\x72\x79\x2e\x6d\x70\x64"
            ];
            const manifestUri = encodedManifest.join("");

            // License Key (Obfuscated)
            const encodedLicenseKey = {
                "\x6b\x65\x79\x73": {
                    "\x31\x65\x63\x65\x33\x65\x63\x62\x34\x31\x36\x39\x39\x65\x38\x35\x35\x63\x36\x64\x63\x39\x61\x32\x38\x33\x39\x30\x38\x32\x31\x30": 
                    "\x62\x61\x30\x38\x62\x65\x37\x36\x37\x65\x31\x61\x35\x65\x38\x39\x37\x37\x37\x65\x36\x38\x61\x36\x39\x39\x38\x61\x38\x63\x31\x39"
                }
            };

            const video = document.getElementById('video');
            const player = new shaka.Player(video);
            const resolutionSelector = document.getElementById('resolution');
            const audioSelector = document.getElementById('audio');

            // Tetapkan User-Agent
            const networkingEngine = player.getNetworkingEngine();
            networkingEngine.registerRequestFilter((type, request) => {
                if (type === shaka.net.NetworkingEngine.RequestType.MANIFEST ||
                    type === shaka.net.NetworkingEngine.RequestType.SEGMENT) {
                    request.headers['User-Agent'] = "Mozilla/5.0 (Linux; Android 12; Pixel 3a XL Build/SP2A.220505.008; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/114.0.5715.0 Mobile Safari/537.36";
                }
            });

            // Pasang ClearKey DRM
            player.configure({
                drm: {
                    clearKeys: encodedLicenseKey["\x6b\x65\x79\x73"]
                }
            });

            try {
                await player.load(manifestUri);
                console.log('Penstriman dimuat dengan jayanya!');

                // Dapatkan senarai resolusi dan audio yang tersedia
                updateResolutionOptions(player);
                updateAudioOptions(player);
            } catch (error) {
                console.error('Ralat semasa memuatkan penstriman:', error);
            }

            // Event listener untuk menukar resolusi
            resolutionSelector.addEventListener("change", () => {
                const selectedHeight = resolutionSelector.value;
                if (selectedHeight === "auto") {
                    player.configure({ abr: { enabled: true } });
                } else {
                    player.configure({ abr: { enabled: false } });
                    setResolution(player, parseInt(selectedHeight));
                }
            });

            // Event listener untuk menukar audio
            audioSelector.addEventListener("change", () => {
                const selectedLang = audioSelector.value;
                setAudioTrack(player, selectedLang);
            });
        }

        function updateResolutionOptions(player) {
            const resolutionSelector = document.getElementById('resolution');
            const tracks = player.getVariantTracks();

            // Kosongkan dropdown sebelum tambah resolusi baru
            resolutionSelector.innerHTML = '<option value="auto">Auto</option>';

            // Tambahkan resolusi ke dalam dropdown
            tracks.forEach(track => {
                const option = document.createElement("option");
                option.value = track.height;
                option.textContent = `${track.height}p (${track.bandwidth / 1000} kbps)`;
                resolutionSelector.appendChild(option);
            });
        }

        function setResolution(player, height) {
            const tracks = player.getVariantTracks();
            const selectedTrack = tracks.find(track => track.height === height);

            if (selectedTrack) {
                player.selectVariantTrack(selectedTrack, true);
                console.log(`Resolusi ditukar ke: ${height}p`);
            }
        }

        function updateAudioOptions(player) {
            const audioSelector = document.getElementById('audio');
            const audioTracks = player.getVariantTracks()
                .filter(track => track.audioBandwidth); // Ambil trek audio sahaja

            // Kosongkan pilihan audio sebelum tambah
            audioSelector.innerHTML = '';

            // Cari bahasa unik
            const uniqueLanguages = [...new Set(audioTracks.map(track => track.language))];

            uniqueLanguages.forEach(lang => {
                const option = document.createElement("option");
                option.value = lang;
                option.textContent = lang.toUpperCase(); // Tunjuk sebagai huruf besar (contoh: "EN", "MY")
                audioSelector.appendChild(option);
            });
        }

        function setAudioTrack(player, language) {
            const audioTracks = player.getVariantTracks()
                .filter(track => track.language === language);

            if (audioTracks.length > 0) {
                player.selectVariantTrack(audioTracks[0], true);
                console.log(`Trek audio ditukar ke: ${language}`);
            }
        }

        document.addEventListener('DOMContentLoaded', initPlayer);
    </script>
</body>
</html>
